<?php/** * Created by PhpStorm. * User: chenyouxi * Date: 2019/7/13 * Time: 9:50 AM */namespace app\common\service;use think\facade\Session as Session;use think\facade\Cookie as Cookie;use think\facade\Cache;use app\common\service\Http as http;use app\common\service\BaseService as BaseService;use think\Db;class WeixinService extends BaseService{    public $appId = '';    public $appSecret = '';    public function __construct()    {        $this->appId = "wxc9bd54b019c0df2d";        $this->appSecret = "d00c8e9ac5926b40a5da0a4ab5397183";        $this->http = new Http();    }    public function getAccessToken($type = 0)    {        $access_obj = db('access_token_expires')->where('autoId', 1)->find();        $now = intval(time());        if (!($this->checkTokenExpires($access_obj['access_token'])) && $access_obj && (($now - 1200) < intval($access_obj['expires_in'])))        {            return array('errcode' => 0, 'access_token' => $access_obj['access_token']);        }        $url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . trim($this->appId) . '&secret=' . trim($this->appSecret);        $json = json_decode($this->http->curlGet($url));        if (!empty($json->errmsg))        {            return array('errcode' => $json->errcode, 'errmsg' => $json->errmsg);        }        if ($access_obj)        {            db('access_token_expires')->where('autoId', $access_obj['autoId'])->update(array('access_token' => $json->access_token, 'expires_in' => intval($json->expires_in + $now)));        }        else        {            db('access_token_expires')->insert(array('access_token' => $json->access_token, 'expires_in' => intval($json->expires_in + $now)));        }        return array('errcode' => 0, 'access_token' => $json->access_token);    }    /**     * @param $token     * @return bool     * 获取微信服务器IP地址     */    public function checkTokenExpires($token)    {        $url_get = 'https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=' . $token;        $res = json_decode($this->http->curlGet($url_get), true);        if(!empty($res['errcode'])){            if (($res['errcode'] == '40013') || ($res['errcode'] == '40001') || ($res['errcode'] == '42001'))            {                return true;            }        }        return false;    }}