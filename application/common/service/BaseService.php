<?php/** * Created by PhpStorm. * UserModel: chenyouxi * Date: 2019/5/27 * Time: 2:41 PM */namespace app\common\service;use think\Controller;use think\facade\Session as Session;use think\facade\Cache as Cache;use think\Request;class BaseService{    protected $userId;    protected $userMobile;    public function __construct(){        $this->init();    }    /**     * 初始化数据     */    private function init(){        //获取userId        $this->userId = Session::get('userId');        $this->userMobile = Session::get('userMobile');    }    /**     * 把返回的数据集转换成Tree     * @param array $list 要转换的数据集     * @param string $pid parent标记字段     * @param string $level level标记字段     * @return array     */    function listToTree($list, $pk='id', $pid = 'pid', $child = '_child', $root = 0) {        for($k = 0;$k<count($list);$k++)        {            $list[$k][$child] = array();        }        // 创建Tree        for($i = count($list)-1;$i>=0;$i--)        {            for($j = 0;$j<count($list);$j++)            {                if($list[$j][$pk] == $list[$i][$pid])                {                    if(empty($list[$j][$child]))                    {                        $list[$j][$child][0] = $list[$i];                    }else{                        $list[$j][$child] = array_push($list[$j][$child], $list[$i]);                    }                }            }        }        return $list;    }    /**     * 添加缓存key值     * @param unknown $key     * @param unknown $value     */    public function addCacheKeyTag($key,$tag)    {        $key_list = $this->Cache->get($key);        if(empty($key_list))        {            $key_list = array();        }        if(!in_array($tag, $key_list))        {            $key_list[] = $tag;            $this->Cache->set($key, $key_list);        }    }    /**     * 清除对应key相关tag的所有缓存     * @param unknown $key     */    public function clearKeyCache($key)    {        $key_list = $this->Cache->get($key);        if(!empty($key_list))        {            foreach ($key_list as $k => $v)            {                $this->Cache->set($v, '');            }        }    }    /**     * 添加日志     * @param unknown $uid     * @param unknown $is_system     * @param unknown $controller  控制器中文名     * @param unknown $method  方法中文名     * @param unknown $ip      ip地址     * @param unknown $get_data  操作数据详情     * @return boolean     */    public function addUserLog($uid, $is_system, $controller, $method, $get_data)    {        $url = Request::instance()->url(true);        $ip = Request::instance()->ip();        //查询用户名称        if($uid == 0)        {            $user_name = '系统';        }else{            $user_model = new UserModel();            $user_info = $user_model->getInfo(['uid' => $uid], 'nick_name');            if(!empty($user_info))            {                $user_name = $user_info['nick_name'];            }else{                $user_name = '未知';            }        }        $data = array(            'uid' => $uid,            'url' => $url,            'user_name' => $user_name,            'is_system' => $is_system,            'controller' => $controller,            'method' => $method,            'ip' => $ip,            'data' => $get_data,            'create_time' => time()        );        $user_log = new UserLogModel();        $res = $user_log->save($data);        return $res;    }}