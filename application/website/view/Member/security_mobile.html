{include file="./public/header" }
{include file="./public/navbar" }
{css rel="stylesheet" href="__CSS__/member_security.css" }
<style>

</style>
<div class="ns-main w1200">
    {include file="./public/member_menu" }

    <div class="member-main">
        <!-- 修改密码 -->
        <section>
            <div class="main-top">
                <div class="title">手机绑定</div>
            </div>
            <div class="setting-cont clearfix">
                <div class="stepflex stepflex-te">
                    <dl class="normal doing ns-border-color">
                        <dt class="s-num ns-bg-color">1</dt>
                        <dd class="s-text">绑定手机</dd>
                    </dl>
                    <dl class="last">
                        <dt class="s-num ns-bg-color-gray">2</dt>
                        <dd class="s-text"> 完成</dd>
                    </dl>
                </div>

                <div class="form-horizontal">

                    <div class="form-group row mb-4">
                        <label class="col-sm-2">手机号码</label>
                        <div class="col-md-6 col-sm-10 list-inline-item">
                            <input type="text" class="form-control form-control-sm" name="mobile" placeholder="请输入手机号">
                        </div>
                    </div>

                    <div class="form-group row mb-4">
                        <label class="col-sm-2">验证码</label>
                        <div class="col-md-3 col-sm-5 list-inline-item">
                            <input type="text" style="width: 120px;" id="captcha" placeholder="请输入验证码" name="captcha" tabindex="2" autocomplete="off" class="form-control form-control-sm" />
                        </div>
                        <div class="list-inline-item item">
                            <img class="img-captcha verifyimg" src="/website/verify" onclick="this.src='/website/verify?tag=1'+'&send='+Math.random()" alt="captcha" style="vertical-align: middle; cursor: pointer; height: 41px;" />
                        </div>
                    </div>



                    <div class="form-group row mb-4">
                        <label class="col-sm-2">手机验证码</label>
                        <div class="col-md-3 col-sm-5 list-inline-item">
                            <input type="text" style="width: 130px;" maxlength="6" class="form-control form-control-sm" name="verify" placeholder="请输入手机验证码">
                        </div>
                        <div class="my-auto">

                            <button class="btn btn-primary btn-sm btn-block code" onclick="memberInfoOperation.sendSmsCaptcha(this);" type="button">获取验证码</button>
                        </div>
                    </div>



                    <div class="form-group row mb-4">
                        <div class="col-12 col-sm-2 offset-sm-4">
                            <button class="btn btn-primary btn-sm btn-block " type="button" onclick="memberInfoOperation.confirm(this);">
                                <span class="iconfont icon-correct font-size-1 mr-1"></span>
                                保存
                            </button>
                        </div>
                    </div>
                </div>

                <div class="js-finish verify-success none" id="finish_password">
                    <p>手机绑定成功!</p>
                </div>
            </div>
        </section>
    </div>


</div>

<script>
    var isClick = false;

    var memberInfoOperation = {
        field: {},
        confirm: function (event) {
            this.getFieldValue(event);
            if (this.verification()) {
                if (isClick) return;
                isClick = true;
                this.submit();
            }
        },
        // 表单提交
        submit: function () {
            var self = this;
            $.post("/website/modifyMobile", self.field, function (res) {
                sendCodeId = 0;
                isClick = false;
                if (res.status == "success") {
                    layer.msg(res.msg);
                    $(".doing").removeClass("ns-border-color");
                    $(".doing .sum").removeClass("ns-bg-color");
                    $(".doing .sum").addClass("ns-bg-color-gray");
                    $(".last").addClass("ns-border-color");
                    $(".last .sum").addClass("ns-border-color");
                    $(".last .sum").removeClass("ns-bg-color-gray");
                    $(".js-finish").show();
                    $(".form-horizontal").hide();
                    setTimeout(function () {
                        location.href = '/website/memberSecurity';
                    }, 2000);
                }else{
                    layer.msg(res.msg);
                }
            },"json");
        },
        // 数据验证
        verification: function () {
            var self = this,
                field = this.field;

            if (field.mobile == '') {
                layer.msg('手机号不能为空');
                $("input[name=mobile]").focus();
                return false;
            } else if (field.mobile.search(regex.mobile) == -1) {
                layer.msg('手机号格式不正确');
                $("input[name=mobile]").focus();
                return false;
            }

            if (field.captcha == '') {
                layer.msg('请输入验证码');
                $("input[name=captcha]").focus();
                return false;
            }
            if (field.verify == '') {
                layer.msg('请输入手机验证码');
                $("input[name=verify]").focus();
                return false;
            }


            return true;
        },
        // 获取表单数据
        getFieldValue: function (event) {
            var self = this;

            var formObj = $(event).parents('.form-horizontal');

            if (formObj.find('[name]').length > 0) {

                formObj.find('[name]').each(function () {
                    var name = $(this).attr('name'),
                        value = $(this).val();
                    self['field'][name] = value;
                })
            }
        },
        // 发送短信验证码
        sendSmsCaptcha: function (event) {
            var mobile = $("input[name=mobile]").val();

            if ( mobile == '') {
                layer.msg('手机号不能为空');
                $("input[name=mobile]").focus();
                return false;
            } else if (mobile.search(regex.mobile) == -1) {
                layer.msg('手机号格式不正确');
                $("input[name=mobile]").focus();
                return false;
            }
            $.post('/website/sms', {
                "mobile": mobile,
                "type": "verify"
            }, function (data) {

                if (data.status == "success") {
                    countDown(event);
                } else {
                    layer.msg(data.msg);
                    $("input[name=mobile]").focus();
                }
            }, "json");
        }
    };

    // 倒计时
    function countDown(chageObj, oldText, time) {
        var time = time != undefined ? time : 120,
            oldText = oldText != undefined ? oldText : '获取动态码',
            text = time + 's后重新获取';

        if (time > 0) {
            $(chageObj).text(text).addClass('disabled');
            time -= 1;
            setTimeout(function () {
                countDown(chageObj, oldText, time);
            }, 1000);
        } else {
            $(chageObj).text(oldText).removeClass('disabled');
        }
    }
</script>

{include file="./public/footer" }