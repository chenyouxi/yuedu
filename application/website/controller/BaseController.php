<?php/** * Created by PhpStorm. * User: chenyouxi * Date: 2019/6/20 * Time: 9:44 AM */namespace app\website\controller;use think\Controller;use think\Request;use think\facade\Cookie;use think\facade\Session;use app\common\service\User;use app\common\service\Sms;use app\common\model\SystemModel as System;class BaseController extends Controller{    public $user;    protected $userId;    protected $userMobile;    public function __construct()    {        parent::__construct();        $this->init();        $this->user = new User();        $this->userId = $this->user->getSessionUid();        $this->userMobile = $this->user->getSessionMobile();        //校验是否已经登录        if($this->userId){            $userInfo = $this->user->getUserInfo("integral,nickName,wxUnionid,userFace,sessionId,userMobile");            $sessionId = Cookie::get(md5("91amz".$this->userId));            if(unlock_url($userInfo['sessionId']) != $sessionId){                Session::set('userId', '');                Session::set('userMobile', '');                $this->error("登录已过期，请重新登录！",'/website/login');            }            //获取该用户的未读消息            $this->sms = new Sms();            $smsCount = $this -> sms -> getCount(["userId"=>$this->userId,"status"=>"-1","smsType"=>1]);            $getSmsList = $this -> sms -> getList(1, 2, ["userId"=>$this->userId,"status"=>"-1","smsType"=>1], "autoId DESC","arr");            foreach( $getSmsList as $key => &$value ){                $content =  preg_replace("/<img.*?>/si","",$value['content']);                $content = trim($content,'\0');                $content = substr( strip_tags($content), 0, 100 );                if(strlen($content)>0){                    $value['content'] = $content."...";                } else {                    $value['content'] = "您有一条新消息，请点击查看消息详情……";                }            }        }        //获取系统配置信息        $system = System::getFieldValue();        $this->assign('system',$system);        $this->assign("getSmsList" , empty($getSmsList) ? null : $getSmsList );        $this->assign("userMobile" , empty($this->userMobile) ? "" : $this->userMobile );        $this->assign("smsCount" , empty($smsCount) ? 0 : $smsCount );        $this->assign("isLogin" , empty($this->userId) ? 0 : 1 );        $this->assign("userInfo" , empty($userInfo) ? "" : $userInfo );    }    public function init(){    }    /**     * 校验是否已绑定手机号     */    public function isBindPhone(){        if( empty($this->userMobile) || !$this->userMobile ){            $this->redirect("/website/perfectInfo");        }    }    /**     * 校验是否已经登录     */    public function isLogin(){        if( empty($this->userId) || !$this->userId ){            $this->redirect("/website/login");        }    }}