<?php/** * Created by PhpStorm. * User: chenyouxi * Date: 2019/7/13 * Time: 9:02 AM */namespace app\website\controller;use app\common\service\WeixinService as wxService;use app\common\service\Wechat as Wechat;use app\common\service\Http as Http;use app\common\service\User as User;use think\facade\Cache as Cache;use think\Controller;class Weixin extends BaseController{    protected $appId;    protected $appSecret;    public function __construct()    {        $this->init();        $this->http = new Http();        $this->user = new User();        $this->userId = $this->user->getSessionUid();    }    public function init()    {        $this->wxService = new wxService();        $this->config = [            'wx_token' => 'c7ca0639d4aa5b8899188ea89f83da72',            'wx_encodingaeskey' => '9wCgH0nSl3UmZE1DWZVcqu7XKxE5sX2xba7C6CE10A7',            'wx_appid' => 'wxc9bd54b019c0df2d',            'wechat_encodingaeskey' => "9wCgH0nSl3UmZE1DWZVcqu7XKxE5sX2xba7C6CE10A7",            'wechat_encode' => '0'//消息加解密方式        ];    }    public function index()    {        $wechat = new Wechat($this->config);        $data = $wechat->request();        list($content, $type) = $this->reply($data);        if ($content) {            $wechat->response($content, $type);        } else {            exit('success');        }    }    /**     *  关注公众号自动消息回复     */    private function reply($data)    {        $keyword = isset($data['Content']) ? $data['Content'] : '';        $eventKey = isset($data['EventKey']) ? $data['EventKey'] : '';        $ticket = isset($data['EventKey']) ? $data['Ticket'] : '';        $ticketArr = [];        $mer_id = 0;        $id = $data['EventKey'];        if (!isset($data['Event']) || 'UNSUBSCRIBE' != strtoupper($data['Event'])) {            //校验该微信号是否已经绑定            $userInfo = $this->user->getUserDetailByWx($data['FromUserName']);            if($userInfo){                $this->user->updateUser(["wxOpenid" => $data['FromUserName']],["isFollow"=>1]);            }        }        //获取用户信息        $openid = $data['FromUserName'];        if($ticket){            $ticketArr['status'] = 1;            $ticketArr['openid'] = $openid;            Cache::set( $ticket,$ticketArr);        }        $userInfo = $this->user->getUserDetailByWx($openid);        error_log("\r\n".date("Y-m-d H:i:s").",run1:".json_encode($userInfo),3,dirname(__FILE__)."/__index.log");        if ($data['MsgType'] == 'event') {            switch (strtoupper($data['Event'])) {                case 'SCAN':                    //扫码                    $userId = $eventKey;                    if(!$userInfo){                        //获取微信信息 进行注册                        $access_token = $this -> wxService->getAccessToken();                        $weixin_data = $nickname = $headimgurl = $userLocation = "";                        if ($access_token['errcode'] == 0) {                            $url = "https://api.weixin.qq.com/cgi-bin/user/info?access_token={$access_token['access_token']}&openid={$openid}&lang=zh_CN";                            $res = $this->http->curlGet($url);                            $weixin_data = json_decode($res, TRUE);                            //注册                            Cache::set($ticket."_weixinInfo" , json_encode($weixin_data) ,60*60*60);                        }                        if($userId > 0){                            //为了绑定现有帐号，这里把用户id通过EventKey带过来                            $this->user->updateUser(["userId" => $userId],["isFollow"=>1 ,"nickName"=> $nickname,"userFace"=>$headimgurl,"wxOpenid" => $openid ,"wxInfo"=> json_encode($weixin_data),'userLocation' => $userLocation]);                            return array("绑定成功","text");                        } else {                            //注册                            Cache::set($ticket."_weixinInfo" , json_encode($weixin_data) ,60*60*60);                            return array("关注成功","text");                        }                    } else {                        //直接登录                        $ticketArr['status'] = 2;                        $ticketArr['openid'] = $openid;                        error_log("\r\n".date("Y-m-d H:i:s").",run1:".json_encode($ticketArr),3,dirname(__FILE__)."/__index.log");                        Cache::set( $ticket,$ticketArr);                        if($userId > 0){                            return array("绑定失败，您已绑定其他帐号","text");                        } else {                            return array("登录成功","text");                        }                    }                    break;                case 'SUBSCRIBE':                    //关注公众号，绑定用户信息                    $userId = ltrim( $eventKey ,"qrscene_");                    if($userInfo){                        //已绑定过                        $this->user->updateUser(["wxOpenid" => $openid],["isFollow"=>1]);                        //登录                        $ticketArr['status'] = 2;//1扫码成功，2已注册直接登录                        $ticketArr['openid'] = $openid;                        Cache::set( $ticket,$ticketArr);                        return array("关注成功","text");                    } else {                        //获取微信信息                        $access_token = $this -> wxService->getAccessToken();                        $weixin_data = $nickname = $headimgurl = $userLocation = "";                        if ($access_token['errcode'] == 0) {                            $url = "https://api.weixin.qq.com/cgi-bin/user/info?access_token={$access_token['access_token']}&openid={$openid}&lang=zh_CN";                            $res = $this->http->curlGet($url);                            $weixin_data = json_decode($res, TRUE);                            $nickname = $weixin_data['nickname'];                            $headimgurl = $weixin_data['headimgurl'];                            $userLocation = $weixin_data['country'].$weixin_data['province'].$weixin_data['city'];                        }                        if($userId > 0){                            //为了绑定现有帐号，这里把用户id通过EventKey带过来                            $this->user->updateUser(["userId" => $userId],["isFollow"=>1 ,"nickName"=> $nickname,"userFace"=>$headimgurl,"wxOpenid" => $openid ,"wxInfo"=> json_encode($weixin_data),'userLocation' => $userLocation]);                            return array("绑定成功","text");                        } else {                            //注册                            Cache::set($ticket."_weixinInfo" , json_encode($weixin_data) ,60*60*60);                            return array("关注成功","text");                        }                    }                    break;                case 'UNSUBSCRIBE':                    //用户取消关注                    $this->user->updateUser(["wxOpenid" => $data['FromUserName']],["isFollow"=>'-1']);                    return array("BYE-BYE", 'text');                    break;                case 'LOCATION':                    exit('success');                default:                    //return array("亲，此号暂停测试，请搜索【pigcms】进行关注测试", 'text');            }        } elseif ($data['MsgType'] == 'text') {            //接收用户发送的消息            $content = $data['Content'];        } elseif ($data['MsgType'] == 'location') {        } else {        }        return false;    }    /**     *  生成带参数二维码     */    public function getQrCode(){        //获取token        $access_token 	= $this -> wxService->getAccessToken();        if(!empty($access_token['access_token'])){            $url = "https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=".$access_token['access_token'];            $postData = [                "expire_seconds" => 604800,                "action_name" => "QR_SCENE",                "action_info" => [                    "scene" => [                        "scene_id" => intval($this->userId)                    ]                ]            ];            $http = new Http();            $data = $http::curlPost($url,json_encode($postData));            $ticketArr['status'] = '-1';            $ticketArr['openid'] = '';            Cache::set($data['ticket'],$ticketArr);            //通过ticket换取二维码            $showQrCodeUrl = "https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=".urlencode($data['ticket']);            $data['showQrCodeUrl'] = $showQrCodeUrl;//            $showQrCode = $http::curlGet($showQrCodeUrl);//            var_dump($showQrCode);exit;            if( $data['errcode'] == 0 ){                result_success( $data );            } else {                result_error("111111","生成二维码失败");            }        } else {            result_error("111111","生成二维码失败");        }    }    /**     * 获取二维码状态     */    public function getQrState()    {        if (request()->isAjax()) {            $ticket = request()->post('ticket','');            if( $ticket ){                $ticketArr = Cache::get($ticket);                if( $ticketArr['status'] == 1 && $ticketArr['openid']){                    //已扫码                    result_success($ticketArr,'success');                } else if ( $ticketArr['status'] == 2 && $ticketArr['openid'] ){                    //已注册                    result_success($ticketArr,'success');                }                else{                    result_error("111111","未扫码");                }            }        }    }}