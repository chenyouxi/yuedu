<?php/** * * +---------------------------------------------------------------------- *                      .::::. *                    .::::::::.            | AUTHOR: chenyouxi *                    :::::::::::           | EMAIL: 905100794@qq.com *                 ..:::::::::::'           | QQ: 905100794 *             '::::::::::::'               | WECHAT: xi20130618 *                .::::::::::               | DATETIME: 2019/9/19 5:37 下午 *           '::::::::::::::.. *                ..::::::::::::. *              ``:::::::::::::::: *               ::::``:::::::::'        .:::. *              ::::'   ':::::'       .::::::::. *            .::::'      ::::     .:::::::'::::. *           .:::'       :::::  .:::::::::' ':::::. *          .::'        :::::.:::::::::'      ':::::. *         .::'         ::::::::::::::'         ``::::. *     ...:::           ::::::::::::'              ``::. *   ```` ':.          ':::::::::'                  ::::.. *                      '.:::::'                    ':'````.. * +---------------------------------------------------------------------- */namespace app\admin\controller;use app\common\model\Book;use OSS\OssClient;use OSS\Core\OssException;use app\common\model\BookType as M;use think\facade\Config;use think\facade\Db;use think\facade\Request;use think\facade\View;class BookType extends Base{    // 列表    public function index()    {        //全局查询条件        $where = [];        $keyword = Request::param('keyword');        if (!empty($keyword)) {            $where[] = ['name', 'like', '%'.$keyword.'%'];        }        $dateran = Request::param('dateran');        if (!empty($dateran)) {            $getDateran = get_dateran($dateran);            $where[] = ['create_time', 'between', $getDateran];        }        //获取列表        $list = M::getList($where, $this->pageSize);        $view = [            'keyword'  => $keyword,            'dateran'  => $dateran,            'pageSize' => page_size($this->pageSize, $list->total()),            'page'     => $list->render(),            'list'     => $list,            'empty'    => empty_list(12),        ];        View::assign($view);        return View::fetch();    }    //更新分类    public function update(){        //获取目录        $oss = new \Oss();        $data = $oss->getlistObjects();        //获取目录列表,更新        if (!empty($data['listPrefix'])) {            foreach ($data['listPrefix'] as $prefixInfo) {                $prefixArr = explode( $data['delimiter'],$prefixInfo->getPrefix() );                $preArr = [];                foreach ($prefixArr as $key => $value) {                    $preArr[] = $value;                }                //目录名称更新数据库                $bookTypeInfo = M::where('name','=',$preArr[2])->find();                if(!$bookTypeInfo){                    $addData = [                        'name'=>$preArr[2],                        'status'=>1,                        'create_time' => time()                    ];                    M::create($addData);                } else {                    M::update([ "update_time"=>time() ],[ "name"=>$preArr[2] ]);                }            }        }        $this->success('更新成功', 'BookType/index');    }}